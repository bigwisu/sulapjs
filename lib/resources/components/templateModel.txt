import React, { useState, useEffect } from 'react';
import { Container, Table, Button, Row, Col, Modal, Form, Spinner } from 'react-bootstrap'
import RowTable from './RowTableNewModel';
import axios from '../api/database';
import Toast from './ToastComponent';

function //model-name (props) {

    const [ showModal, setShowModal ] = useState(false)
    const [ rowTable, setRowTable ] = useState([])
    //state-name
    const [ search, setSearch ] = useState('')
    //state
    
    const [ id , setId ] = useState('')
    const [ loading, setLoading ] = useState(false)

    //function-loop
    //state-object

    //toast
    const [ textToast, setTextToast ] = useState('')
    const [ statusToast, setStatusToast ] = useState(false)
    const [ showToast, setShowToast ] = useState(false) 

   function submitForm(e){
        e.preventDefault()
       
        if(id){
            axios.patch(`///model-lower-cases/${id}`, stateObj  ,{ headers:{ token:localStorage.getItem('token')}})
            .then(({data}) => {
                let tempTable = rowTable.map((el,index) => {
                    if(el._id == data.updated//model-name._id){
                        el = data.updated//model-name
                    }
                    return el;
                })
                setRowTable(tempTable)
            })
            .catch(err =>{
                setTextToast(err.response.data.message)
                setStatusToast(false)
                setShowToast(true)
            })
        } else {
            axios.post('///model-lower-cases', stateObj, { headers: { token:localStorage.getItem('token')}})
            .then(({data}) => {
                setRowTable([...rowTable, data.new//model-name])
                setTextToast('success add')
                setStatusToast(true)
                setShowToast(true)
            })
            .catch(err => {
                setTextToast(err.response.data.message)
                setStatusToast(false)
                setShowToast(true)
            })
    
            let tempRow = [ ...rowTable, stateObj ]
            setRowTable(tempRow)
            funcLoop.map( func => (
                func('')
            ))
        }
        handleClose()
    }

    function deleteData(id){
        axios.delete(`///model-lower-cases/${id}`, { headers: { token:localStorage.getItem('token')}})
            .then(({data}) => {
                let tempTable = rowTable.filter((el,index) => {
                    return el._id !== id
                })
                setRowTable(tempTable)
                setTextToast('delete success')
                setStatusToast(true)
                setShowToast(true)
            })
            .catch(err => {
                setTextToast(err.response.data.message)
                setStatusToast(false)
                setShowToast(true)
            })
    }

    function handleClose() {
        setShowModal(false);
        funcLoop.map( func => (
            func('')
        ))
        setId('')
    }
    
    function editData(rowData){
        Object.keys(stateObj).map((el, index) => {
            funcLoop[index](rowData[el])
        })
        setId(rowData._id)
        handleShow()
    }

    function handleShow() {
        setShowModal(true);
    }
    
    function submitSearch(e){
        e.preventDefault()
        axios.get(`///model-lower-cases?search=${search}`, { headers:{ token:localStorage.getItem('token')}})
        .then(({ data }) =>{
            setRowTable([...data.//model-names])
        })
        .catch(err => {
            setTextToast(err.response.data.message)
            setStatusToast(false)
            setShowToast(true)
        })
    }

     //function-upload-image
    function uploadImage(e, functionSetImage){
        e.preventDefault()
        let formData = new FormData();
        formData.append('file', e.target.files[0]);
        console.log(e.target.files[0])
        axios.post('/upload', formData, { headers: {token:localStorage.getItem('token')}})
        .then(({data}) =>{
            functionSetImage(data.image)
        })
        .catch(err => {
            console.log(err)
        })

    }

    function fetchData(){
        setLoading(true)
        axios.get('///model-lower-cases', { headers: { token: localStorage.getItem('token')}})
        .then(({data}) => {
            if(data.//model-names){
                setRowTable(data.//model-names)
            }
        })
        .catch(err =>{
            setTextToast(err.response.data.message)
            setStatusToast(false)
            setShowToast(true)
        })
        .finally(() => {
            setLoading(false)
        })
    }

    useEffect(() => {
        if(!search){
            fetchData()
        }
    }, [search])

    useEffect(() => {
        fetchData()
    }, [])

    return (
        <>
            <Toast text={textToast} status={ statusToast } show={ showToast} set={ setShowToast }/>
            { loading ?
                <div className='d-flex justify-content-center align-items-center'>
                    <Spinner animation="border" role="status">
                        <span className="sr-only">Loading...</span>
                    </Spinner>
                </div>
                :    
                <Container fluid>
                    <div style={{ padding:'30px' }}>
                        <Row>
                            <Col>
                                <h3> <span style={{ color:'grey' }}>#</span> //model-name </h3>
                            </Col>
                            <Col className='d-flex justify-content-end'>
                                <Button variant='outline-primary' onClick={ handleShow }> <i className="fas fa-plus"></i> Add New </Button>
                            </Col>
                        </Row>

                        <Form className='ml-3' onSubmit={ submitSearch }>
                            <Row className='mt-3'>
                                <Col lg={3} style={{ padding:0 }}>
                                    <Form.Group className='shadow-sm'>
                                        <Form.Control type="text" placeholder="Search..." onChange={(e) => setSearch(e.target.value)}/>
                                    </Form.Group>
                                </Col>
                                <Col lg={1}>
                                    <Form.Group>
                                        <Button type='submit' className='shadow-sm'><i className="fas fa-search"></i></Button>
                                    </Form.Group>
                                </Col>
                            </Row>
                        </Form>
                
                        <div className='shadow-sm mt-3'>
                            <Table striped bordered hover>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        { ['ID',...Object.keys(stateType), 'CreatedAt', 'UpdatedAt', 'Actions'].map((el, index) =>{
                                            return <th key={ index }> {el} </th>
                                        })}
                                    </tr>
                                </thead>
                                <tbody>
                                    { rowTable.map( (row, index) => {
                                        return <RowTable value={ row } index={index} key={ index } key_model={ Object.keys(stateType) } edit={ editData } delete={ deleteData }/>
                                    }) }
                                </tbody>
                            </Table>
                        </div>
                    </div>
                </Container>
        }

        <Form >
            <Modal show={showModal} onHide={handleClose}>
                <Modal.Header closeButton>
                    <Modal.Title>Add //model-name </Modal.Title>
                </Modal.Header>
                <Modal.Body>
                    { Object.keys(stateObj).map((el, index) => {
                        return (
                        stateType[el] === 'string' && <Form.Group key={ index }>
                            <Form.Control type="text" placeholder={`Enter ${ el }`} onChange={ e => funcLoop[index]( e.target.value)} value={ stateObj[el] }/>
                        </Form.Group> 
                        ||
                        stateType[el] === 'boolean' && <Form.Group key={ index }>
                        <Form.Label>{`Enter ${ el }`}</Form.Label>
                            <Form.Control  as="select" onChange={ e => funcLoop[index]( e.target.value)} value={ stateObj[el]} >
                                <option>true</option>
                                <option>false</option>
                            </Form.Control> 
                        </Form.Group>
                        ||
                        stateType[el] === 'text' && <Form.Group key={ index } >
                            <Form.Label>Enter {el}</Form.Label>
                            <Form.Control as="textarea" rows="3" onChange={ e => funcLoop[index]( e.target.value)} value={ stateObj[el]}/>
                        </Form.Group>
                        ||
                        stateType[el] === 'image' && 
                        <div key={ index }>
                            <div style={{ overflow:'hidden', width:'100%', height:'200px', backgroundColor:'#dedede' }} className='mb-2'>
                                <img width='100%' src={ stateObj[el] ? `http://localhost:3000/uploads/${stateObj[el]}` : null} />
                            </div>
                            <input type='file' onChange={ (e) => uploadImage(e, funcLoop[index])}/>
                            <Button onClick={ (e) =>{ funcLoop[index]('') }}> remove image </Button>
                        </div>
                    )
                    }) }
                </Modal.Body>
                <Modal.Footer>
                    <Button variant="secondary" onClick={handleClose}>
                        Close
                    </Button>
                    <Button variant="primary" onClick={ submitForm }>
                        Save Changes
                    </Button>
                </Modal.Footer>
            </Modal>                                 
        </Form>               
        </>
    );
}

export default //model-name